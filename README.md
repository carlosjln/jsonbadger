# JsonBadger

JsonBadger is a Node.js library that brings document-style querying to PostgreSQL JSONB.
It includes schema validation, model APIs, query compilation, and migration helpers.

## Why did I create this utility?

I originally built my personal systems and small business client projects using MongoDB and Mongoose. Over time, that setup was no longer viable or cost-effective on shared hosting. I needed a solution that was more contained and budget-friendly. Since most shared hosting providers offer free, robust PostgreSQL databases, I created this utility to leverage PostgreSQL's `jsonb` fields as an alternative for document-based storage.

## Table of Contents

- [Install](#install)
- [Examples (Quick Start)](#examples-quick-start)
- [Examples Cheat Sheet](#examples-cheat-sheet)
- [Core Features](#core-features)
- [Documentation](#documentation)
- [Author](#author)
- [License](#license)

## Install

Requirements:
- Node.js >=20
- PostgreSQL

```bash
npm install jsonbadger
```

## Examples (Quick Start)

```js
import jsonbadger from 'jsonbadger';

// 1. Connect to database
await jsonbadger.connect('postgresql://user:pass@localhost:5432/dbname', {
	debug: false,
	max: 10,
	ssl: false,
	auto_index: true,
	id_strategy: jsonbadger.IdStrategies.bigserial // server default: bigserial | uuidv7 (native PostgreSQL uuidv7() required)
});

// 2. Define schema (FieldType format)
const user_schema = new jsonbadger.Schema({
	user_name: {type: String, required: true, index: true},
	age: {type: Number, min: 0, index: -1},
	type: {type: String},
	email: {type: String, index: {unique: true, name: 'idx_users_email_unique'}}
});

// 3. Declare indexes on schema (path-level + schema-level compound index)
// Object-form create_index(...) is how you define a compound index.
user_schema.create_index({user_name: 1, type: -1});

// 4. Create model
const User = jsonbadger.model(user_schema, {
	table_name: 'users',
	data_column: 'data',
	auto_index: false, // optional model-level override
	id_strategy: jsonbadger.IdStrategies.bigserial // optional model-level override (uuidv7 uses DB-generated ids)
});

// 5. Run migrations manually (optional if you rely on first-write auto table creation via save()/update_one())
await User.ensure_table();
await User.ensure_index();

// 6. Save a document
const saved_user = await new User({
	user_name: 'john',
	age: 30,
	type: 'admin'
}).save();

// 7. Find a document
const found_user = await User.find_one({
	user_name: 'john'
}).exec();
```

When using `IdStrategies.uuidv7`, jsonbadger checks PostgreSQL native `uuidv7()` support automatically during `connect(...)` and reuses cached capability metadata for later model-level `uuidv7` overrides. You do not need to run manual version checks; `SELECT version();` and `SHOW server_version;` are optional troubleshooting commands only.

## Examples Cheat Sheet

For a complete copy-paste operator and runtime cheat sheet (queries, updates, and document methods), see `docs/examples.md`.

## Core Features

* **JSONB-first**: Model API designed specifically for PostgreSQL JSONB.
* **Validation**: FieldType-based schema validation built in.
* **Querying**: Mongo-style query operators (e.g., `$gt`, `$regex`) compiled into SQL.
* **Runtime document APIs**: `get`, `set`, alias virtuals, serialization helpers, `mark_modified`/dirty tracking, and immutable enforcement after save.
* **JSON update operators**: PostgreSQL-native `jsonb_set`, `jsonb_insert`, and `jsonb_set_lax` support in `update_one(...)`.
* **Migrations**: Helpers for `ensure_table` and `ensure_index`.
* **Configurable row IDs**: use `IdStrategies.bigserial` and `IdStrategies.uuidv7` (`uuidv7` is generated by PostgreSQL via native `uuidv7()` support).
* **Configurable index lifecycle**: `auto_index` can be set at connection and overridden per model.
* **UUIDv7 compatibility gating**: jsonbadger checks support automatically and fails early with server version/capability context when unavailable.
* **Modern**: Native ESM package.

## Documentation

* `docs/api.md`
* `docs/examples.md` (complete example cheat sheet for queries, updates, and runtime document methods)
* `docs/query-translation.md` (includes PostgreSQL capability map for query/update operators and indexability expectations)
* `docs/local-integration-testing.md`
* `CHANGELOG.md` for release notes and version history

## Author

**Carlos LÃ³pez**
* GitHub: [@carlosjln](https://github.com/carlosjln)

## License

MIT. See `LICENSE`.
